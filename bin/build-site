#!/bin/sh
USAGE="Usage: $0 [ -v ] [ <directory> ]"
QUIET=--quiet

# command-line options
OPTS=`getopt -o v -n "$0" -- "$@"`
if [ $? != 0 ] ; then
    echo $USAGE >&2
    exit 1
fi

eval set -- "$OPTS"
while true ; do
    case "$1" in
        -v)
            QUIET=
            shift ;;
        --) shift ; break ;;
        *)
            echo "Internal error!" >&2
            echo $USAGE            >&2
            exit 1 ;;
    esac
done

# our directories
SRC=`readlink -f $(dirname $0)/..`
LNK=$1

# default
if [ -z $LNK ] ; then LNK=cpan.io ; fi

# make sure the local target directory exists
if [ ! -e `dirname $LNK` ] ; then mkdir -p `dirname $LNK` ; fi

# build the target for site generation
DST=$LNK-`date -u +%Y%m%d-%H%M%S`
mkdir -p $DST

# update the external documents
$SRC/bin/update-ref

# generate the static pages
eval `perl -Mlocal::lib`
wallflower \
    $QUIET \
    --include $SRC/lib \
    --destination $DST \
    --application $SRC/bin/cpanio.cgi

# symlink dance
ln -s -L -f $DST $LNK

# drop all older versions
rm -rf `ls -d $LNK-* | sort -r | tail +3`
